<html>
<head>
<title>routes.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #000080; font-weight: bold;}
.s1 { color: #000000;}
.s2 { color: #808080; font-style: italic;}
.s3 { color: #008000; font-weight: bold;}
.s4 { color: #0000ff;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
routes.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span>flask <span class="s0">import </span>render_template, url_for, flash, redirect, request
<span class="s0">from </span>app <span class="s0">import </span>bcrypt, db
<span class="s0">from </span>app.users.forms <span class="s0">import </span>RegistrationForm, RegistrationBusinessForm, LoginForm, UpdateAccountForm, RequestResetForm, ResetPasswordForm,UpdateAccountBusinessForm
<span class="s0">from </span>app.users.utils <span class="s0">import </span>save_picture
<span class="s0">from </span>models <span class="s0">import </span>User, Post, Business, Event, JoinEvent
<span class="s0">from </span>flask_login <span class="s0">import </span>login_user, current_user, logout_user, login_required
<span class="s0">from </span>app.users <span class="s0">import </span>users

<span class="s0">from </span>PIL <span class="s0">import </span>Image <span class="s2">#- non so perche non vada min 38.18 lezione 7</span>

@users.route(<span class="s3">&quot;/registration&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
<span class="s0">def </span>general():
 <span class="s0">return </span>render_template(<span class="s3">'registration.html'</span>, title=<span class="s3">'Registration'</span>)

@users.route(<span class="s3">&quot;/&lt;usertype&gt;/registration&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
<span class="s0">def </span>registration(usertype):
    <span class="s0">if </span>current_user.is_authenticated:
        <span class="s0">return </span>redirect(url_for(<span class="s3">'home'</span>))

    <span class="s0">if </span>usertype == <span class="s3">'private'</span>:
        form = RegistrationForm()
        <span class="s2"># if already logged in , i can use current user</span>
        <span class="s0">if </span>form.validate_on_submit():  <span class="s2"># dice se è valido il form dopo il submit</span>
            hashed_password = bcrypt.generate_password_hash(form.password.data).decode(<span class="s3">'utf-8'</span>)
            <span class="s2"># create a new user</span>
            user = User(username=form.username.data, email=form.email.data, telephone=form.telephone.data,
                        password=hashed_password)
            db.session.add(user)
            db.session.commit()
            flash(<span class="s3">'your account has been created! now you can login'</span>, <span class="s3">'success'</span>)
            <span class="s0">return </span>redirect(url_for(<span class="s3">'users.login'</span>))
        <span class="s0">return </span>render_template(<span class="s3">'registration_user.html'</span>, title=<span class="s3">'Registration User'</span>, form=form)

    <span class="s0">elif </span>usertype == <span class="s3">'business'</span>:
        form = RegistrationBusinessForm()
        <span class="s0">if </span>form.validate_on_submit():  <span class="s2"># dice se è valido il form dopo il submit</span>
            hashed_password = bcrypt.generate_password_hash(form.password.data).decode(<span class="s3">'utf-8'</span>)
            <span class="s2"># create a new user</span>
            business = Business(name=form.name.data, email=form.email.data, vat_number=form.vat_number.data,
                                telephone=form.telephone.data, city=form.city.data, address=form.address.data,
                                password=hashed_password)
            db.session.add(business)
            db.session.commit()
            flash(<span class="s3">'your account has been created! now you can loging'</span>, <span class="s3">'success'</span>)
            <span class="s0">return </span>redirect(url_for(<span class="s3">'users.login'</span>))
        <span class="s0">return </span>render_template(<span class="s3">'registration_business.html'</span>, title=<span class="s3">'Registration Business'</span>, form=form)

@users.route(<span class="s3">&quot;/account&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
@login_required
<span class="s0">def </span>account():
    <span class="s2">#image file is where we store --&gt; now create a variable</span>
    form= UpdateAccountForm() <span class="s2">#importo il form sopra e poi gli dico form= al tipo di form importato sopra</span>
    <span class="s2">#e poi lo faccio returnare sotto</span>
    <span class="s0">if </span>form.validate_on_submit():
        <span class="s0">if </span>form.picture.data:
            picture_file = save_picture(form.picture.data)
            current_user.image_file = picture_file
        current_user.username = form.username.data
        current_user.email = form.email.data
        db.session.commit()
        flash(<span class="s3">'your account has been updated'</span>, <span class="s3">'success'</span>)
        <span class="s0">return </span>redirect(url_for(<span class="s3">'users.account'</span>))
    <span class="s0">elif </span>request.method == <span class="s3">'GET'</span>:
        form.username.data = current_user.username
        form.email.data = current_user.email
    image_file = url_for(<span class="s3">'static'</span>, filename=<span class="s3">'profile_pics/'</span>+current_user.image_file)<span class="s2">#devo mettere la cartella+la route</span>
    <span class="s0">return </span>render_template(<span class="s3">'account.html'</span>, title=<span class="s3">'Account'</span>,image_file=image_file, form=form)

@users.route(<span class="s3">&quot;/account_business&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
@login_required
<span class="s0">def </span>account_business():
    form= UpdateAccountBusinessForm()
    <span class="s0">if </span>form.validate_on_submit():
        <span class="s0">if </span>form.picture.data:
            picture_file = save_picture(form.picture.data)
            current_user.image_file = picture_file
        current_user.name = form.name.data
        current_user.email = form.email.data
        db.session.commit()
        flash(<span class="s3">'your account has been updated'</span>, <span class="s3">'success'</span>)
        <span class="s0">return </span>redirect(url_for(<span class="s3">'users.account_business'</span>))
    <span class="s0">elif </span>request.method == <span class="s3">'GET'</span>:
        form.name.data = current_user.name
        form.email.data = current_user.email
    image_file = url_for(<span class="s3">'static'</span>, filename=<span class="s3">'profile_pics/'</span>+current_user.image_file)<span class="s2">#devo mettere la cartella+la route</span>
    <span class="s0">return </span>render_template(<span class="s3">'account_business.html'</span>, title=<span class="s3">'Account Business'</span>,image_file=image_file, form=form)


@users.route(<span class="s3">&quot;/login&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
<span class="s0">def </span>login():
    <span class="s0">if </span>current_user.is_authenticated:
        <span class="s0">return </span>redirect(url_for(<span class="s3">'main.home'</span>))

    form = LoginForm()
    <span class="s0">if </span>form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()
        business = Business.query.filter_by(email=form.email.data).first()
        <span class="s0">if </span>user != <span class="s0">None</span>:
         <span class="s0">if </span>user <span class="s0">and </span>bcrypt.check_password_hash(user.password, form.password.data):
            login_user(user, remember=form.remember.data)
            next_page=request.args.get(<span class="s3">'next'</span>) <span class="s2">#get fa tornare none se non esiste</span>
            <span class="s0">return </span>redirect(next_page) <span class="s0">if </span>next_page <span class="s0">else </span>redirect(url_for(<span class="s3">'main.home'</span>))
         <span class="s0">else</span>:
            flash(<span class="s3">'Login Unsuccessful. Please check email and password'</span>, <span class="s3">'danger'</span>)
        <span class="s0">elif </span>business!=<span class="s0">None</span>:
            <span class="s0">if </span>business <span class="s0">and </span>bcrypt.check_password_hash(business.password, form.password.data):
                login_user(business, remember=form.remember.data)
                next_page = request.args.get(<span class="s3">'next'</span>)  <span class="s2"># get fa tornare none se non esiste</span>
                <span class="s0">return </span>redirect(next_page) <span class="s0">if </span>next_page <span class="s0">else </span>redirect(url_for(<span class="s3">'main.home'</span>))
            <span class="s0">else</span>:
                flash(<span class="s3">'Login Unsuccessful. Please check email and password'</span>, <span class="s3">'danger'</span>)
    <span class="s0">return </span>render_template(<span class="s3">'login.html'</span>, title=<span class="s3">'Login'</span>, form=form)

@users.route(<span class="s3">&quot;/logout&quot;</span>)
<span class="s0">def </span>logout():
    logout_user()
    <span class="s0">return </span>redirect(url_for(<span class="s3">'main.home'</span>))

@users.route(<span class="s3">&quot;/user/events_joined&quot;</span>)
<span class="s0">def </span>user_events():
    page = request.args.get(<span class="s3">'page'</span>, <span class="s4">1</span>, type=int)
    print (current_user.id)
    jevents = JoinEvent.query.filter_by(user_id= current_user.id).all()
    events = []
    print(jevents)
    <span class="s0">for </span>e <span class="s0">in </span>jevents:
        ev = Event.query.filter_by(id = e.event_id).first()
        <span class="s0">if </span>ev:
            events.append(ev)
    print (events)
    <span class="s0">return </span>render_template(<span class="s3">'user_events.html'</span>, user=current_user, events = events)

@users.route(<span class="s3">&quot;/user/&lt;string:username&gt;&quot;</span>)
<span class="s0">def </span>user_posts(username):
    page = request.args.get(<span class="s3">'page'</span>, <span class="s4">1</span>, type=int)
    user = User.query.filter_by(username=username).first_or_404()
    posts = Post.query.filter_by(author=user)\
        .order_by(Post.date_posted.desc())\
        .paginate(page=page, per_page=<span class="s4">5</span>)
    <span class="s0">return </span>render_template(<span class="s3">'user_posts.html'</span>, posts=posts, user=user)

@users.route(<span class="s3">&quot;/&lt;string:name&gt;&quot;</span>)
<span class="s0">def </span>business_events(name):
    page = request.args.get(<span class="s3">'page'</span>, <span class="s4">1</span>, type=int)
    business = Business.query.filter_by(name=name).first_or_404()
    events = Event.query.filter_by(creator=business).order_by(Event.date_posted.desc()).paginate(page=page, per_page=<span class="s4">5</span>)
    <span class="s0">return </span>render_template(<span class="s3">'business_events.html'</span>, events=events, business=business)


@users.route(<span class="s3">&quot;/reset_password&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
<span class="s0">def </span>reset_request():
    form = RequestResetForm()
    <span class="s0">if </span>current_user.is_authenticated:
        <span class="s0">return </span>redirect(url_for(<span class="s3">'main.home'</span>))
    <span class="s0">return </span>render_template(<span class="s3">'reset_request.html'</span>, title=<span class="s3">'Reset Password'</span>, form=form)


@users.route(<span class="s3">&quot;/reset_password/&lt;token&gt;&quot;</span>, methods=[<span class="s3">'GET'</span>, <span class="s3">'POST'</span>])
<span class="s0">def </span>reset_token(token):

    <span class="s0">if </span>current_user.is_authenticated:
        <span class="s0">return </span>redirect(url_for(<span class="s3">'main.home'</span>))
    user = User.verify_reset_token(token)
    <span class="s0">if </span>user <span class="s0">is None</span>:
        flash(<span class="s3">'That is an invalid or expired token'</span>, <span class="s3">'warning'</span>)
        <span class="s0">return </span>redirect(url_for(<span class="s3">'users.reset_request'</span>))
    form = ResetPasswordForm()
    <span class="s0">if </span>form.validate_on_submit():
        hashed_password = bcrypt.generate_password_hash(form.password.data).decode(<span class="s3">'utf-8'</span>)
        user = User(username=form.username.data, email=form.email.data, password=hashed_password)
        user.password = hashed_password
        db.session.commit()
        flash(<span class="s3">'your psw has been updated! now you can loging'</span>, <span class="s3">'success'</span>)
        <span class="s0">return </span>redirect(url_for(<span class="s3">'users.login'</span>))
    <span class="s0">return </span>render_template(<span class="s3">'reset_token.html'</span>, title=<span class="s3">'Reset Password'</span>, form=form)


</pre>
</body>
</html>